{% extends "base.html" %}

{% block title %}Players{% endblock %}

{% block content %}
<div class="table-container">
    {% if session["role"]%}
        <div class="title-add-container">
            <h1>Player List</h1>
            <div class="add-item">
                <i class="fa-solid fa-plus"></i>
                <a href="#" onclick="event.preventDefault(); openPopup('{{ url_for('player.add_player') }}', 'Add Player');">Add Player</a>
            </div>
        </div>
    {% endif%}
    
    <div class="filter-container">
        
        <div class="filter-group" id="firstname-filter-group" onclick="toggleFilter('firstname-filter-group', event)">
            <label>First Name</label>
            <div class="filter-content">
                <input type="text" id="firstname-filter" name="firstname" value="{{ filters.get('firstname', '') }}" placeholder="Enter First Name">
                <button class="apply-filter-btn" onclick="applyGroupFilters('firstname-filter-group')">Apply</button>
            </div>
        </div>

        
        <div class="filter-group" id="lastname-filter-group" onclick="toggleFilter('lastname-filter-group', event)">
            <label>Last Name</label>
            <div class="filter-content">
                <input type="text" id="lastname-filter" name="lastname" value="{{ filters.get('lastname', '') }}" placeholder="Enter Last Name">
                <button class="apply-filter-btn" onclick="applyGroupFilters('lastname-filter-group')">Apply</button>
            </div>
        </div>

        
        <div class="filter-group" id="country-filter-group" onclick="toggleFilter('country-filter-group', event)">
            <label>Country</label>
            <div class="filter-content">
                <select name="country" id="country-filter">
                    <option value="">All Countries</option>
                    {% for country in countries %}
                    <option value="{{ country.id }}" {% if filters.get('country') == country.id|string %}selected{% endif %}>
                        {{ country.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        
        <div class="filter-group" id="position-filter-group" onclick="toggleFilter('position-filter-group', event)">
            <label>Position</label>
            <div class="filter-content">
                <select name="position" id="position-filter">
                    <option value="">All Positions</option>
                    {% for pos in positions %}
                    <option value="{{ pos }}" {% if filters.get('position') == pos %}selected{% endif %}>
                        {{ pos }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    
    <div class="selected-filters-container">
        <div class="selected-filters">
            
        </div>
        <button class="clear-filters-btn" onclick="clearAllFilters()">Clear Filters</button>
    </div>

    <table>
        <thead>
            <tr>
                <th data-column="firstname" data-type="text">First Name
                    <span class="sort-icon" onclick="sortTable('firstname', 'text')">
                        <i class="fa-solid fa-sort"></i>
                    </span>
                </th>
                <th data-column="lastname" data-type="text">Last Name
                    <span class="sort-icon" onclick="sortTable('lastname', 'text')">
                        <i class="fa-solid fa-sort"></i>
                    </span>
                </th>
                <th data-column="country" data-type="text">Country
                    <span class="sort-icon" onclick="sortTable('country', 'text')">
                        <i class="fa-solid fa-sort"></i>
                    </span>
                </th>
                <th data-column="position" data-type="text">Position
                    <span class="sort-icon" onclick="sortTable('position', 'text')">
                        <i class="fa-solid fa-sort"></i>
                    </span>
                </th>
                <th style="width: 13%;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr>
                <td data-column="firstname">{{ player.firstname }}</td>
                <td data-column="lastname">{{ player.lastname }}</td>
                <td data-column="country">{{ player.country }}</td>
                <td data-column="position">{{ player.position }}</td>
                <td>
                    <div class="action-links">
                        <a href="{{ url_for('player.get_player', id=player.id) }}">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                        {% if session["role"]%}
                            <a href="#" onclick="event.preventDefault(); openPopup('{{ url_for('player.edit_player', id=player.id) }}', 'Edit Player');">
                                <i class="fa-solid fa-pen"></i>
                            </a>
                            <form method="POST" action="{{ url_for('player.delete_player', id=player.id) }}" style="display:inline;">
                                <button type="submit" onclick="return confirm('Are you sure?');">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </form>
                        {%endif%}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
function updateSelectedFilters() {
    const selectedFiltersContainer = document.querySelector('.selected-filters');
    selectedFiltersContainer.innerHTML = ''; 

    const countryFilter = document.getElementById('country-filter');
    if (countryFilter && countryFilter.value.trim() !== '') {
        const selectedOption = countryFilter.options[countryFilter.selectedIndex];
        const selectedCountryName = selectedOption ? selectedOption.textContent : 'Unknown Country';
        if (selectedCountryName !== 'All Countries') {
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            tag.innerHTML = `Country: ${selectedCountryName} 
                <button onclick="removeFilter('country-filter')">&times;</button>`;
            selectedFiltersContainer.appendChild(tag);
        }
    }

    const filters = [
        { id: 'firstname-filter', label: 'First Name' },
        { id: 'lastname-filter', label: 'Last Name' },
        { id: 'position-filter', label: 'Position' }
    ];

    filters.forEach(filter => {
        const element = document.getElementById(filter.id);
        if (element && element.value && element.value !== 'All') {
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            tag.innerHTML = `${filter.label}: ${element.value} 
                <button onclick="removeFilter('${filter.id}')">&times;</button>`;
            selectedFiltersContainer.appendChild(tag);
        }
    });

    updateClearFiltersVisibility();
}

function removeFilter(filterId) {
    const element = document.getElementById(filterId);
    if (element) {
        if (element.tagName === 'SELECT') {
            element.value = '';  
        } else if (element.tagName === 'INPUT') {
            element.value = ''; 
        }
    }

    updateSelectedFilters();
    applyFilters();
}
</script>
{% endblock %}
